---
show: step
version: 1.0
enable_checker: true
---

# Zabbix ç›‘æ§ Nginx

## ä½¿ç”¨ Zabbix ç›‘æ§ Nginx

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åŸºæœ¬æŒæ¡äº† Zabbix ç›‘æ§çš„æ­å»ºï¼Œé‚£ä¹ˆè¿™èŠ‚å®éªŒå°±æ¥è¿›è¡Œä¸€ä¸‹å®æˆ˜ã€‚

è®©æˆ‘ä»¬ä¸€èµ·æ¥å°è¯•ç”¨ Zabbix ç›‘æ§ Nginx æœåŠ¡ï¼Œé€šè¿‡å®æˆ˜å­¦ä¹  Zabbix çš„åŸºæœ¬ä½¿ç”¨ã€‚

> è¯·ç¡®ä¿å·²ç»é…ç½®å¥½äº† zabbix æœåŠ¡ã€‚

#### å®éªŒçŸ¥è¯†ç‚¹

- Nginx çŠ¶æ€é¡µé¢é…ç½®
- Zabbix ç›‘æ§ Nginx

## é…ç½® Nginx çŠ¶æ€é¡µé¢

åœ¨ç¬¬äºŒä¸ªå®éªŒéƒ¨ç½² Nginx Web æœåŠ¡å™¨å®éªŒä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¼šäº† Nginx çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼å’Œå¼€å¯çŠ¶æ€é¡µé¢çš„æ–¹å¼ï¼Œæœ¬éƒ¨åˆ†æ˜¯å¯¹ä¹‹å‰å†…å®¹çš„å›é¡¾ã€‚

Nginx çš„é…ç½®ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€æ˜¯ä¿®æ”¹é»˜è®¤ç«¯å£ï¼ŒäºŒæ˜¯é…ç½®çŠ¶æ€é¡µã€‚

#### ğŸ’¡ ä¿®æ”¹é»˜è®¤ç«¯å£

ç”±äº Zabbix ä½¿ç”¨çš„ Apache2 å·²ç»å ç”¨äº† 80 ç«¯å£ï¼Œè€Œ Nginx çš„é»˜è®¤ç«¯å£ä¹Ÿæ˜¯ 80ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† Nginx çš„ default é…ç½®ä¿®æ”¹ä¸º 80 ç«¯å£ä»¥å¤–çš„å…¶ä»–ç«¯å£ã€‚

é¦–å…ˆï¼Œå®éªŒæ¥¼ç¯å¢ƒä¸‹å·²ç»å®‰è£…äº† Nginxï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹æœ¬å®éªŒç¯å¢ƒä¸‹çš„ Nginx ç‰ˆæœ¬å’Œé…ç½®å‚æ•°ä¿¡æ¯ç­‰ã€‚

```bash
sudo vim /etc/nginx/conf.d/default.conf
```

å°†é‡Œé¢çš„ listen çš„é‚£ä¸ª 80 æ”¹æˆ 8090 è¿™ä¸ªç«¯å£æˆ–è€…å…¶ä»–æ²¡æœ‰ç”¨çš„ç«¯å£å³å¯ã€‚

æ³¨æ„ï¼š8080 ç«¯å£éœ€è¦é…ç½®å¼€å¯çŠ¶æ€é¡µï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609831852862)

#### ğŸ’¡ é…ç½®çŠ¶æ€é¡µ

æ–°å»ºä¸€ä¸ª conf æ–‡ä»¶

```bash
cd /etc/nginx/conf.d/
sudo touch status.conf
```

ä½¿ç”¨ Vim ç¼–è¾‘å™¨è¿›è¡Œç¼–è¾‘ã€‚

```bash
sudo vim status.conf
```

é”®å…¥ä¸‹é¢çš„å†…å®¹ï¼š

```nginx
server {
	listen 8080 default_server;

	server_name localhost;

    location /nginx_status {
        stub_status on;
    }
}
```

å®ƒè¡¨ç¤ºç›‘å¬ 8080 ç«¯å£ï¼Œå¯¹äº URI `/nginx_status`ï¼Œæˆ‘ä»¬å¯ç”¨æ¨¡å— `stub_status` è¿›è¡Œå“åº”ã€‚

#### ğŸ’¡ é‡æ–°å¯åŠ¨ nginx

å…ˆæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼š

```bash
sudo nginx -t
```

å½“çœ‹åˆ° OK å­—æ ·åï¼Œå†é‡æ–°å¯åŠ¨ Nginx

```bash
sudo service nginx start
```

#### ğŸ’¡ æŸ¥çœ‹çŠ¶æ€é¡µ

é€šè¿‡ `curl` å·¥å…·è¯»å–çŠ¶æ€é¡µçš„å†…å®¹ã€‚

```bash
curl localhost:8080/nginx_status
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609832016855)

## Shell è„šæœ¬å…¥é—¨

å› ä¸ºæ¥ä¸‹æ¥å¯¹ Agent çš„é…ç½®éœ€è¦ä¸€å®šçš„ Shell çŸ¥è¯†ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè¡¥å……ä¸€ä¸‹ã€‚ä½†ä½œä¸ºå…¥é—¨è¯¾ç¨‹ï¼Œæˆ‘ä»¬ä¸ä¼šè¯¦ç»†åœ°è®²è§£ Shell è„šæœ¬çš„æ–¹æ–¹é¢é¢ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠ Shell è„šæœ¬çœ‹åšå¾ˆå¤šå‘½ä»¤çš„é›†åˆï¼Œå®ƒä¼šæŒ‰ç…§æˆ‘ä»¬è§„å®šçš„é¡ºåºæ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚

#### ğŸ’¡ ç®€å•çš„å°è¯•

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ touch å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ª Shell è„šæœ¬ã€‚

```bash
cd ~
touch test1.sh
```

ç„¶åä½¿ç”¨ Vim æ¥ç¼–è¾‘å®ƒï¼š

```bash
vim test1.sh
```

å†™å…¥ä¸‹é¢çš„å†…å®¹

```bash
#!/bin/bash
echo "hello,shiyanlou1"

echo "My Fist Script"
```

åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä¸‹é¢çš„å‘½ä»¤æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„è„šæœ¬

```bash
bash test1.sh
```

å®Œæ•´çš„æ¼”ç¤ºï¼š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191011-1570774780869/wm)

#### ğŸ’¡ å˜é‡

å’Œç¬¬ä¸€ä¸ªè„šæœ¬é‡‡ç”¨çš„æ–¹å¼ç›¸åŒï¼Œå…ˆ `touch test2.sh`ï¼Œå†è°ƒç”¨ `vim test2.sh` è¿›è¡Œç¼–è¾‘ã€‚è¾“å…¥çš„è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š

```bash
#!/bin/bash
hello="hello,shiyanlou2"
echo $hello
```

å®ƒå®šä¹‰äº†ä¸€ä¸ªå˜é‡ `hello`ï¼Œå®ƒçš„å€¼ä¸º `hello,shiyanlou2` ï¼Œæœ€åæˆ‘ä»¬æ‰“å°äº†è¿™ä¸ªå˜é‡çš„å€¼ã€‚å½“ä¸€ä¸ªç›¸åŒçš„å€¼è¢«å¤šæ¬¡ä½¿ç”¨æ—¶ï¼Œå®šä¹‰å˜é‡æ˜¯æœ€å¥½çš„æ–¹å¼ï¼Œå› ä¸ºåªéœ€ä¿®æ”¹å˜é‡çš„å€¼ï¼Œæ‰€æœ‰å¼•ç”¨å˜é‡å€¼çš„åœ°æ–¹å°±éƒ½è¢«ä¿®æ”¹å•¦~

**æ³¨æ„ï¼š`=` çš„å‰åä¸èƒ½æœ‰ç©ºæ ¼ã€‚**

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œæ‰§è¡Œã€‚

```bash
bash test2.sh
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191011-1570775011824/wm)

#### ğŸ’¡ ä¼ å…¥å‚æ•°

å˜é‡çš„å€¼æ˜¯è¢«å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®å‘½ä»¤çš„ä¸åŒæ¥è®©è„šæœ¬æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œå°±å¿…é¡»é‡‡ç”¨ä¼ å…¥å‚æ•°çš„æ–¹å¼ã€‚

è®©æˆ‘ä»¬é€šè¿‡å®æˆ˜æ¥äº†è§£ä¸€ä¸‹å¦‚ä½•ä¼ å…¥å‚æ•°ã€‚æ–°å»ºä¸€ä¸ª `test3.sh`ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹ã€‚

```bash
#!/bin/bash
echo $1
```

è¿™é‡Œ `$1` å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

è¾“å…¥ä¸‹é¢çš„å‘½ä»¤æ‰§è¡Œè„šæœ¬ã€‚

```bash
bash test3.sh "hello,shiyanlou3"
```

è¿™é‡Œ `"hello,shiyanlou3"` å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼Œæ³¨æ„ `"` ï¼ˆå¼•å·ï¼‰æ˜¯ä¸ä¼šè¢«æ‰“å°çš„ã€‚

æ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191011-1570775283723/wm)

#### ğŸ’¡ å‡½æ•°

ä¸ºäº†ä½¿ç›¸åŒçš„å·¥ä½œä¸å†é‡å¤ï¼Œæˆ‘ä»¬é€šå¸¸å®šä¹‰å‡½æ•°æ¥å°†ç›¸åŒçš„æ“ä½œå†™åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ä¸­å°±å®šä¹‰äº†ä¸€ä¸ªåä¸º `hello` çš„å‡½æ•°ã€‚

```bash
#!/bin/bash
function hello {
  echo "hello,shiyanlou4"
}

$1
```

åªå®šä¹‰ä¸€ä¸ªå‡½æ•°æ˜¯ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œçš„ï¼Œæˆ‘ä»¬å¿…é¡»è¦è°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å®ƒæ‰ä¼šæ‰§è¡Œã€‚å½“æˆ‘ä»¬è°ƒç”¨å‡½æ•°æ—¶ï¼Œå®ƒå°±ä¼šæ‰§è¡Œå‡½æ•°ä½“ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œçš„å‡½æ•°ä½“æ˜¯ `echo "hello,shiyanlou4"`ã€‚

ä¸ºä»€ä¹ˆæœ€åæœ‰ `$1` å‘¢ï¼Ÿè¿™å…¶å®æ˜¯æˆ‘ä»¬è°ƒç”¨å‡½æ•°çš„æ–¹å¼ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä»å‘½ä»¤è¡Œä¼ å…¥è¦è°ƒç”¨çš„å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ä¸º `/bin/bash test4.sh hello`ï¼Œé‚£ä¹ˆè„šæœ¬å°±ç›¸å½“äºï¼š

```bash
#!/bin/bash
function hello {
  echo "hello,shiyanlou4"
}

hello
```

è¿™é‡Œç›´æ¥å†™ `hello` å°±æ„å‘³ç€è°ƒç”¨ `hello` å‡½æ•°ã€‚

åˆ›å»ºä¸€ä¸ª `test4.sh` æ¥çœ‹ä¸€ä¸‹ç»“æœå§ï¼š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191011-1570775621753/wm)

### é…ç½® Agent

#### ğŸ’¡ æ·»åŠ è‡ªå®šä¹‰å‚æ•°

åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬çŸ¥é“å¯¹æœåŠ¡çš„ç›‘æ§éœ€è¦é€šè¿‡ Agent å»é‡‡é›†æ•°æ®ï¼Œæ‰€ä»¥ä¸‹é¢å°±è¯¥å¯¹ Agent è¿›è¡Œé…ç½®ã€‚

åœ¨ `/etc/zabbix/zabbix_agentd.conf` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰å‚æ•°ï¼Œè®© Agent ä½¿ç”¨è„šæœ¬æ¥é‡‡é›† Nginx çš„æ•°æ®ï¼Œç„¶åå‘é€ç»™ serverã€‚

```bash
sudo vim /etc/zabbix/zabbix_agentd.conf
```

éœ€è¦åœ¨æœ«å°¾æ·»åŠ çš„å†…å®¹å¦‚ä¸‹ï¼š

```bash
UserParameter=nginx.status[*],/bin/bash /etc/zabbix/zabbix_agentd.d/nginx_status.sh $1
```

è¿™é‡Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ `UserParameter`ã€‚æˆ‘ä»¬è¯¦ç»†è®²è§£ä¸€ä¸‹è‡ªå®šä¹‰å‚æ•°çš„å«ä¹‰ã€‚

æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è®©è¢«ç›‘æ§ç«¯æ‰§è¡Œä¸€ä¸ª Zabbix æ²¡æœ‰é¢„å®šä¹‰çš„æ£€æµ‹ï¼ŒZabbix çš„ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°åŠŸèƒ½æä¾›äº†è¿™ä¸ªæ–¹æ³•ã€‚

å…¶è¯­æ³•è§„èŒƒä¸ºï¼š

```bash
UserParameter=key,command
```

`key` ä½¿æˆ‘ä»¬å®šä¹‰çš„å‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œ`[*]` è¡¨ç¤ºé‡Œé¢å¯ä»¥ä¼ é€’å¤šä¸ªå‚æ•°ã€‚

å¦‚æœ Zabbix è°ƒç”¨ keyï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„ commandï¼ˆå‘½ä»¤ï¼‰ã€‚æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬è°ƒç”¨çš„ key ä¸º `nginx.status['active']`ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„å‘½ä»¤ä¸ºï¼š`/bin/bash /etc/zabbix/zabbix_agentd.d/nginx_status.sh active`ï¼Œè¿™é‡Œçš„ `$1` ä¼šè¢«æ›¿æ¢ä¸º key ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191009-1570615584478/wm)

#### ğŸ’¡ é‡‡é›†è„šæœ¬

æ¥ç€æˆ‘ä»¬æ¥ç¼–å†™ä¸‹ç”¨äºé‡‡é›†æ•°æ®çš„ä¿¡æ¯çš„è„šæœ¬ï¼Œæ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š

```bash
sudo vim /etc/zabbix/zabbix_agentd.d/nginx_status.sh
```

è„šæœ¬çš„å†…å®¹å¦‚ä¸‹ï¼Œå®ƒå®šä¹‰äº†è®¸å¤š Shell å‡½æ•°ï¼Œæ˜¯ç”¨æ¥é‡‡é›†ä¿¡æ¯çš„å…³é”®ã€‚è„šæœ¬çš„ç»“æ„éå¸¸ç®€å•ï¼Œå®šä¹‰äº†ä¸€äº›å˜é‡ç”¨æ¥è®°å½•ä¸€äº›å‡½æ•°å…¬ç”¨çš„å€¼ã€‚

æ¯ä¸ªå‡½æ•°çš„å†…å®¹éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œæ¯”å¦‚ `/usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| grep 'Active' | awk '{print $NF}'`ã€‚çœ‹èµ·æ¥éå¸¸é•¿ï¼Œä½†æ˜¯ä»”ç»†ä¸€åˆ†æä½ ä¼šå‘ç°è¿™ä¸ªå‘½ä»¤å¹¶ä¸å¤æ‚ã€‚

`curl` ä»ä¸€ä¸ªé“¾æ¥ `"http://$HOST:$PORT/nginx_status"`ï¼ˆå³æˆ‘ä»¬çš„ Nginx çŠ¶æ€é¡µï¼‰è·å–æ•°æ®ï¼Œç„¶åä¼ é€’ç»™ grep ç­›é€‰ï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆåªéœ€è¦å®ƒçš„å€¼ï¼ˆå³å¯¹åº”çš„é¡¹çš„æ•°å€¼ï¼‰ï¼Œæ‰€ä»¥åˆäº¤ç»™ `awk` è¿›è¡Œå¤„ç†ã€‚

`awk` æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ–‡æœ¬å¤„ç†å™¨ï¼Œå®ƒçš„ç”¨æ³•å·²ç»å¤šåˆ°å¯ä»¥å•ç‹¬å‡ºä¸€æœ¬ä¹¦ã€‚é™äºç¯‡å¹…ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è¿›è¡Œå±•å¼€è®²è§£ï¼Œåªéœ€è¦çŸ¥é“å®ƒçš„åŠŸèƒ½å°±æ˜¯è·å–å¯¹åº”ç›‘æ§é¡¹çš„å€¼å°±å¯ä»¥äº†ã€‚

åœ¨å‡½æ•°çš„æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ `$1` æ¥è·å–è¦æ‰§è¡Œçš„å‡½æ•°ï¼ˆåœ¨ Shell è„šæœ¬å…¥é—¨ä¸€å°èŠ‚ä¸­æˆ‘ä»¬å·²ç»è®²è§£è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤å®ƒçš„ä½œç”¨ï¼‰ã€‚

```bash
#!/bin/bash

# è®¾ç½®å˜é‡
BKUP_DATE=`/bin/date +%Y%m%d`
LOG="/data/log/zabbix/webstatus.log"
HOST=127.0.0.1  # ç¡®ä¿ CURL èƒ½è®¿é—®è¿™ä¸ªä¸»æœºçš„ IP åœ°å€
PORT="8080"    # ç«¯å£å·

# ç¼–å†™å‡½æ•°ç”¨äºè·å– nginx çš„ç»Ÿè®¡ä¿¡æ¯
function active {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| grep 'Active' | awk '{print $NF}'
  }
function reading {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| grep 'Reading' | awk '{print $2}'
  }
function writing {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| grep 'Writing' | awk '{print $4}'
}

function waiting {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| grep 'Waiting' | awk '{print $6}'
}

function accepts {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| awk NR==3 | awk '{print $1}'
}

function handled {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| awk NR==3 | awk '{print $2}'
}

function requests {
  /usr/bin/curl "http://$HOST:$PORT/nginx_status" 2>/dev/null| awk NR==3 | awk '{print $3}'
}

$1
```

æ·»åŠ è„šæœ¬çš„è¿‡ç¨‹å’Œ Shell è„šæœ¬å…¥é—¨ä¸€å°èŠ‚ä¸­æ˜¯ç›¸ä¼¼çš„ã€‚å¯ä»¥å‚è€ƒä¸‹é¢çš„æ¼”ç¤º â†“

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191009-1570616037249/wm)

æ·»åŠ å¥½é‡‡é›†è„šæœ¬ä¹‹åï¼Œå¯åŠ¨ Zabbix Agent æœåŠ¡ã€‚

```bash
sudo /usr/sbin/zabbix_agentd --foreground -c /etc/zabbix/zabbix_agentd.conf
```

### æµ‹è¯•æ•°æ®é‡‡é›†

Zabbix Agent ç›‘æ§ä»£ç†è·å–ï¼ˆé‡‡é›†ï¼‰æ•°æ®å¯ä»¥é€šè¿‡ `zabbix_get` è¿›ç¨‹æ¥å–å¾—ã€‚å¯ä»¥ç”¨ `zabbix-get` æ¥æµ‹è¯•ä¸€ä¸‹æ•°æ®çš„é‡‡é›†æ˜¯å¦æˆåŠŸã€‚

è¿™é‡Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸‹ `zabbix-get` è¿™ä¸ªè½¯ä»¶åŒ…ã€‚

```bash
sudo apt-get install zabbix-get
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191009-1570616238687/wm)

æµ‹è¯•çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[accepts]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[handled]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[requests]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[active]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[reading]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[writing]'

sudo zabbix_get -s 127.0.0.1 -k 'nginx.status[waiting]'
```

> `-s`: æŒ‡å®šå®¢æˆ·ç«¯ä¸»æœºåæˆ–è€… IP ã€‚ç”±äºæ˜¯é‡‡é›†æœ¬æœºçš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨å›ç¯åœ°å€ `127.0.0.1` æˆ–è€… `localhost`ã€‚
>
> `-k`: ä½ æƒ³è·å–çš„ key ã€‚è¿™é‡Œçš„ Key æ˜¯ä¹‹å‰åœ¨ `UserParameter` ä¸­å®šä¹‰çš„ã€‚

è¿”å›ä¸€ä¸ªæ•°æ®åˆ™è¡¨ç¤ºé…ç½®æˆåŠŸï¼Œå¦‚ä¸‹æ˜¯æµ‹è¯•ç»“æœï¼Œä½ å¾—åˆ°çš„å€¼ä¸ä¸€å®šä¸å›¾ç‰‡ä¸­çš„ç›¸åŒã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid977658-20191010-1570684183786)

## Zabbix ç›‘æ§é…ç½®

#### ğŸ’¡ é…ç½®æµç¨‹

ä¸‹é¢å°±æ˜¯ Zabbix ç›‘æ§ç³»ç»Ÿçš„é…ç½®æ­¥éª¤ã€‚

å¤§ä½“çš„æµç¨‹æ˜¯ï¼š

- ï¼ˆ1ï¼‰æ·»åŠ è¦ç›‘æ§çš„ Agentï¼ˆè¿™ä¸€æ­¥éª¤åœ¨ä¸Šä¸€ä¸ªå®éªŒä¸­å·²ç»å®Œæˆï¼Œå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ä¿å­˜çš„ç¯å¢ƒï¼Œå°±éœ€è¦é‡æ–°è¿›è¡Œé…ç½®ï¼‰ã€‚
- ï¼ˆ2ï¼‰ç»™ä¸»æœºæ·»åŠ ç›‘æ§é¡¹ï¼Œå³æˆ‘ä»¬æƒ³è¦ç›‘æ§çš„æŒ‡æ ‡ã€‚
- ï¼ˆ3ï¼‰å°†æˆ‘ä»¬ç›‘æ§é¡¹æŒ‰ç»„åˆ’åˆ†ä¸ºä¸¤ä¸ªå›¾å½¢ã€‚
- ï¼ˆ4ï¼‰å°†å›¾å½¢æ±‡æ€»åˆ°ä¸€ä¸ªèšåˆå›¾å½¢ä¸Šã€‚

#### ğŸ’¡ æŒ‡æ ‡åˆ†ç»„

åœ¨å¼€å§‹è¿›è¡Œé…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°†ä¸ƒä¸ªæŒ‡æ ‡è¿›è¡Œåˆ†ç»„ã€‚

å›é¡¾ä¸€ä¸‹ï¼Œä¹‹å‰ `nginx_status` çš„ä¸ƒä¸ªæŒ‡æ ‡ï¼š

- `active connections` â€“ æ´»è·ƒçš„è¿æ¥æ•°é‡
- `server accepts handled requests` â€” `accepts` è¡¨ç¤ºæ€»å…±å¤„ç†çš„è¿æ¥æ•°ï¼Œ`handled` è¡¨ç¤ºæˆåŠŸåˆ›å»ºæ¡æ‰‹çš„æ¬¡æ•°ï¼Œ`requests` è¡¨ç¤ºæ€»å…±å¤„ç†çš„è¯·æ±‚æ•°
- `reading` â€” è¯»å–å®¢æˆ·ç«¯çš„è¿æ¥æ•°
- `writing` â€” å“åº”æ•°æ®åˆ°å®¢æˆ·ç«¯çš„æ•°é‡
- `waiting` â€” Nginx å·²ç»å¤„ç†å®Œæ­£åœ¨ç­‰å€™ä¸‹ä¸€æ¬¡è¯·æ±‚æŒ‡ä»¤çš„é©»ç•™è¿æ¥æ•°

æˆ‘ä»¬å°†å…¶åˆ†ä¸ºä¸¤ä¸ªç»„

- ä¸è¿æ¥ç›¸å…³çš„ï¼š`active`ã€`reading`ã€`writing`ã€`waiting`
- ä¸å¤„ç†è¯·æ±‚ç›¸å…³çš„ï¼š`accepts`ã€`handled`ã€`requests`

### åˆ›å»ºç›‘æ§é¡¹

é¦–å…ˆæ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥ `localhost/zabbix` è¿›å…¥ Zabbix çš„å‰ç«¯ã€‚

ä¾æ¬¡ç‚¹å‡»èœå•æ çš„ â€œé…ç½®â€ â†’ â€œä¸»æœºâ€ï¼Œç„¶åé€‰æ‹©ä¸»æœº localhost çš„â€œç›‘æ§é¡¹â€ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609832952752)

ç‚¹å‡»ä¹‹åè¿›å…¥åˆ°ç›‘æ§é¡¹é¡µé¢ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ â€œåˆ›å»ºç›‘æ§é¡¹â€ æŒ‰é’®ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833013743)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦åˆ†åˆ«ä¸º 7 ä¸ªæŒ‡æ ‡æ·»åŠ ç›‘æ§é¡¹ã€‚åˆ›å»ºç›‘æ§é¡¹çš„æ–¹å¼éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œæˆ‘ä»¬åªä¼šè¯¦ç»†çš„è®²è§£ `nginx.accepts` çš„é…ç½®ï¼Œå…¶ä»–çš„é…ç½®ä¸å…¶æ˜¯ç›¸ä¼¼çš„ã€‚

#### ğŸ’¡ åˆ›å»ºä¸è¿æ¥ç›¸å…³çš„ç›‘æ§é¡¹

- `nginx.accepts`

æˆ‘ä»¬éœ€è¦å¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.accepts`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[accepts]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833107986)

å¡«å†™å¥½ä»¥åï¼Œä¸‹æ‹‰é¡µé¢åˆ°åº•éƒ¨ï¼Œç‚¹å‡»æ·»åŠ å³å¯ã€‚

- nginx.handled

æŒ‰ç…§åŒæ ·æ­¥éª¤æ·»åŠ ç›‘æ§é¡¹ `nginx.handled`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.handled`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[handled]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833302307)

- nginx.requests

æ·»åŠ ç›‘æ§é¡¹ `nginx.requests`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.requests`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[requests]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833359675)

#### ğŸ’¡ åˆ›å»ºä¸å¤„ç†è¯·æ±‚ç›¸å…³çš„ç›‘æ§é¡¹

- nginx.active

æ·»åŠ ç›‘æ§é¡¹ `nginx.active`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.active`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[active]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833436164)

- nginx.reading

æ·»åŠ ç›‘æ§é¡¹ `nginx.reading`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.reading`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[reading]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833501341)

- nginx.writing

æ·»åŠ ç›‘æ§é¡¹ `nginx.writing`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.writing`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[writing]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833565964)

- nginx.waiting

æ·»åŠ ç›‘æ§é¡¹ `nginx.waiting`ï¼šå¡«å†™ç›‘æ§é¡¹çš„åå­—ï¼š`nginx.waiting`ã€‚ç„¶åè¦å¡«å†™é”®å€¼ `nginx.status[waiting]`ã€‚æ›´æ–°æ—¶é—´æ”¹ä¸º `1s`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833620821)

é…ç½®å®Œæˆåï¼ŒçŠ¶æ€æ æ˜¾ç¤ºæ˜¯ `å·²å¯åŠ¨`ï¼Œå¦‚ä¸‹å›¾ï¼š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833653436)

è¿™è¡¨æ˜æˆ‘ä»¬æ·»åŠ çš„ç›‘æ§é¡¹å·²ç»æˆåŠŸå¯ç”¨ã€‚

### åˆ›å»ºå›¾å½¢

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºä¸¤ç»„ç›‘æ§é¡¹åˆ†åˆ«åˆ›å»ºå›¾å½¢ã€‚

å¦‚ä¸‹å›¾ï¼Œç‚¹å‡»ä¸»æœº localhost çš„â€œå›¾å½¢â€ï¼Œå†ç‚¹å‡»å³ä¸Šè§’â€œåˆ›å»ºå›¾å½¢â€ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833727270)

æˆ‘ä»¬éœ€è¦ä¾æ¬¡åˆ›å»ºä¸¤ä¸ªå›¾å½¢ï¼š`nginx_connect` å’Œ `nginx_interact`ã€‚

- ğŸ’¡ nginx_connect

å¡«å†™å›¾å½¢çš„åç§°ä¸º `nginx_connect`ï¼Œç„¶åå°†ç›‘æ§é¡¹æ·»åŠ åˆ°å›¾å½¢ä¸­ã€‚æ·»åŠ ç›‘æ§é¡¹çš„æ–¹å¼å¦‚ä¸‹ã€‚æ³¨æ„æˆ‘ä»¬è¦æ·»åŠ çš„ç›‘æ§é¡¹ä¸º `nginx.accepts`ã€`nginx.handled`ã€`nginx.requests`

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833798550)

æ·»åŠ å®Œæˆåï¼Œç‚¹å‡»åº•éƒ¨çš„ â€œæ·»åŠ â€ æŒ‰é’®ã€‚

- ğŸ’¡ nginx_interact

nginx_interact çš„é…ç½®æ–¹å¼ä¸ nginx_connect æ˜¯ç›¸ä¼¼çš„ã€‚è¦æ³¨æ„ï¼šå›¾å½¢å‘½åä¸º `nginx_interact`ï¼›éœ€è¦æ·»åŠ çš„ç›‘æ§é¡¹ä¸ºï¼š`nginx.active`ã€`nginx.reading`ã€`nginx.writing`ã€`nginx.waiting`ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833935033)

æ·»åŠ å®Œæˆåï¼Œå¯ä»¥åœ¨å›¾å½¢åˆ—è¡¨ä¸­æŸ¥çœ‹ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609833964704)

### åˆ›å»ºèšåˆå›¾å½¢

ä¾æ¬¡ç‚¹å‡»é¡¶éƒ¨çš„ â€œç›‘æµ‹â€ â†’ â€œèšåˆå›¾å½¢â€ï¼Œå†ç‚¹å‡» â€œåˆ›å»ºèšåˆå›¾å½¢â€ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834021626)

åˆ›å»ºä¸€ä¸ªåä¸º `Nginx Status` çš„èšåˆå›¾å½¢ï¼Œé…ç½®ä¸º 1 åˆ— 2 è¡Œã€‚é…ç½®å®Œæˆåï¼Œç‚¹å‡» â€œæ·»åŠ â€ æŒ‰é’®ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834085121)

é€‰æ‹© â€œæ„é€ å‡½æ•°â€ å°±ä¼šè¿›å…¥åˆ°é…ç½®ç•Œé¢ï¼Œå°†ä¹‹å‰çš„ä¸¤ä¸ªå›¾å½¢æ·»åŠ åˆ°èšåˆå›¾å½¢ä¸­ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834125266)

ç‚¹å‡»æ›´æ”¹ï¼Œç„¶ååœ¨å›¾å½¢é‡Œé€‰æ‹©è¦æ·»åŠ çš„å›¾å½¢ nginx_connectã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834292339)

åŒæ ·çš„æ–¹å¼æ·»åŠ å¦å¤–ä¸€ä¸ªå›¾å½¢ï¼Œæ³¨æ„è¦ç‚¹å‡»ç¬¬äºŒä¸ªæ›´æ”¹ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834383389)

å†æ¬¡å›åˆ°èšåˆå›¾å½¢çš„ç•Œé¢ï¼Œç‚¹å‡» `Nginx Status`ï¼ˆå³èšåˆå›¾å½¢çš„åå­—ï¼‰ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834434628)

ç‚¹å‡»ä¹‹åå°±èƒ½çœ‹åˆ°æˆ‘ä»¬çš„ç›‘æ§æ•°æ®ã€‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid871732-20210105-1609834467309)

é…ç½® Zabbix ç›‘æ§ Nginx çš„å®éªŒåˆ°æ­¤å°±ç»“æŸäº†ã€‚

## æ€»ç»“

æœ¬èŠ‚å®éªŒä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å®æˆ˜ Zabbix ç›‘æ§ Nginx Web æœåŠ¡å™¨æ¥å­¦ä¹  Zabbix æ·»åŠ æœåŠ¡ç›‘æ§çš„åŸºæœ¬æ­¥éª¤ã€‚

å›é¡¾æœ¬èŠ‚å®éªŒçš„çŸ¥è¯†ç‚¹ï¼š

- Nginx æœåŠ¡é…ç½®
- é…ç½® Zabbix ç›‘æ§ Nginx

æœ¬è¯¾ç¨‹åˆ°æ­¤å°±ç»“æŸäº†ã€‚å¦‚æœä½ æƒ³å­¦ä¹ æ›´å¤š DevOps çŸ¥è¯†ï¼Œå¯ä»¥å…³æ³¨ [æ¥¼+ ä¹‹ Linux è¿ç»´ä¸ DevOps å®æˆ˜](https://www.lanqiao.cn/louplus/linux)ã€‚

**ğŸ’¡ ä¸€ä¸ªäººå­¤é›¶é›¶åœ°å­¦ä¹ ç¼–ç¨‹ï¼Œå¾ˆå®¹æ˜“â€œä»å…¥é—¨åˆ°æ”¾å¼ƒâ€ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯å’Œæœ‹å‹ä¸€èµ·å­¦ä¹ ï½æ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„ã€ŒLinux å­¦ä¹ äº¤æµç¾¤ã€ï¼Œä¸€ç¾¤å¿—åŒé“åˆçš„å°ä¼™ä¼´åœ¨ç­‰ç€ä½ ï½æ‰«ç æ·»åŠ ç­ä¸»ä»»å¾®ä¿¡ ï¼ˆsylmm003ï¼‰ å³å¯è¿›ç¾¤ ğŸ˜‰ã€‚**

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid8504-20191023-1571815193664)
