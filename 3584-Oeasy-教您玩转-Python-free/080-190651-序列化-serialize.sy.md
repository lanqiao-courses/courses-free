---
show: step
version: 1.0
enable_checker: true
---

# 序列化

## 回忆

- 上次我们研究追加文件
  - 追加文件就是把文件打开
  - 然后在后面写上要写的内容
- 还有读写功能+
  - 这可以让我们既可以读又可以写
- 我还想让程序写点复杂的程序
  - 从文件读取信息
  - 完成个计算
- 可以么？🤔

### 写文件

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629984292217)

- 往文本里面写了两个东西
  - 人名： "oeasy"
  - 工作时间 "12"
- 用"\n"分隔开

### 读文件

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629984522718)

- 可以进行读写操作
- 如果我想把工作时间修改为 byte 型的数字变量呢？

### 写文件

- 先写字符串信息

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629987143591)

- 注意一定要有个`\n`作为分隔符
- 然后就是写二进制字节数字

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629987240493)

- 注意使用追加二进制模式
- 确实在后面追加了一个字节

### 序列化

- 这个过程其实是一个序列化
- 或者叫做串行化 Serialize
- 就像一系列的序列号一样
- 是有顺序存储的字节序列

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210914-1631572119689)

- 我们可以把我们的数据内容
  - 按照字节流的方式
  - 存储于各个地方
  - 这就是序列化 Serialize
- 然后可以再读取字节流
  - 转化为我们的数据内容
  - 这就是反序列化
  - 或者说反串行化
  - deserialize

### 读文件

- 先读出名字
- 用的是默认的 rb 模式

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629987579753)

- 然后是读出工作时间
- 用的是指定的 rb 模式

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629988062808)

- 如果除了名字和工作时长之外
- 还需要读写每小时工资呢？
- 每小时工资是一个 double 型的变量

### 写数据

- 先写名字

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630025769007)

- 再写工作时长

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630025782747)

- 最后写单位时间工资

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630025869293)

- 尝试把他读出来

### 读取数据

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630025948226)

- 尝试 readline
- 但是失败了
- 因为没有 line 的结束标记`\n`
- 重新写

### 重写

- 别忘了`\n`

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630026100747)

- 然后把两个数字型的变量写进去

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630026203466)

- 成功了
- 名字、工作时长、每小时工资这三个数据分别写了进去
- 构成了一个序列 serial
- 这个写文件的过程就是序列化
- 复杂的字处理、电子表格、图像、3d 工程
- 也是按照他们自身定义的序列方式写进文件
- 然后读出来的
- 我们来试试读出来

### 读取

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630026810493)

- 先用 rt 模式读出名字
- 然后找到后面的数字位置
- 名字之后有两个数字
  - b 型 1 个字节
  - d 型 8 个字节
  - 总共 9 个字节
- seek(-9,2)找到从结尾往前 9 个字节的位置
- 先读字节型整数

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630026920988)

- 然后去读取 8 字节的双精度浮点数

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630027053355)

- 总共没几个字节
- 还要读 3 次
- 太费劲了
- 我想直接一次读出来

### 读出来

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630027249172)

- 读出来是没问题的
- 问题是你怎么处理
- 自己想想

### 处理

- 首先是不知道名字有多长
- 如果我知道总长度
- 然后减去后面的 9 个字节的数字位置
- 然后再减去一个分隔符
- 就可以知道名字的长度了

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630027603007)

### 切片

- 既然知道了长度
- 然后就可以把名字先切出来
- 用到的是一个切片操作
  - [0:5] 从第 0 个字节到第 5 个字节之前

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630029941960)

- 切完了名字继续切数字
- 名字之后有个`\n`

### 继续读

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630030315558)

- 名字的长度是 5
- 加上回车是 6
- 第 6 个字节就是工作时长的字节整型数字
- 然后准备读取工资

### 再读

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20211105-1636107799595)

- 读取出 double 型的 salary 数值
- 然后进行输出

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630030772196)

- 完成！✿
- 既然能够一把读出来
- 可以一把写进去么?

### 字节流写入

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630031022671)

- 字节流整合
- 确实可以串起来
- 这样一把写入字节流就更合理了
- 但是有个小问题
- 字符串和数字部分之前没有分隔符
- 还是得有个`\n`

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630031305048)

- 这样就成功写入了
- 而且是序列化地写入
- 如果是修改呢？
- 每次都需要全读需全写么？
- 能否定点修改工作时间

### 读出

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630032039400)

- 首先定点读出数据
- 确认写的位置

### 定点

- 具体写入

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20210827-1630032193288)

- 可以看到`\n`之后的字节被修改为`0x03`
- 试验成功

### 总结

- 这次我们研究数据序列化
  - 字符串、字节型整数、双精度浮点数依次写入
  - 然后可以进行数据类型转化
  - 并且进行运算
  - 可以对于序列化定点写入
- 这并不难
- 我们可以跨文件进行操作么？🤔
- 下次再说 👋
